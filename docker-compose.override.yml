version: "3.1"

# Complementary services, not part of geOrchestra core.
# They are made to ease your life as a developer.
# **NOT** production ready !

volumes:
  smtp_maildir:

services:
  caddy:
    image: lucaslorentz/caddy-docker-proxy:2.8-alpine
    networks:
      - caddy
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./resources/caddy:/data/caddy
    restart: always

  static:
    image: nginx:stable
    restart: unless-stopped
    networks:
      - caddy
    volumes:
      - ./resources/static:/usr/share/nginx/html:ro
      - /etc/localtime:/etc/localtime:ro
    labels:
      - "caddy=georchestra-127-0-1-1.traefik.me"
      - "caddy.tls=internal"
      - "caddy.handle=/public/*"
      - "caddy.handle.0_reverse_proxy={{upstreams 80}}"

  proxy:
    networks:
      - caddy
      - default
    labels:
      - "caddy=georchestra-127-0-1-1.traefik.me"
      - "caddy.tls=internal"
      - "caddy.handle.reverse_proxy={{upstreams 8080}}"
      - "caddy.handle.0_header=Access-Control-Allow-Origin *"
      - "caddy.handle.1_header=Access-Control-Allow-Methods \"GET, POST, PUT, PATCH, DELETE, OPTIONS\""
      - "caddy.handle.2_header=Access-Control-Max-Age 1800"
      - "caddy.handle.3_header=Access-Control-Allow-Credentials: true"
      - "caddy.@trailingslash=path_regexp reg_static ^/(\\w+)$"
      - "caddy.redir=@trailingslash /{http.regexp.reg_static.1}/"

  cas:
    networks:
      - caddy
      - default
    labels:
      - "caddy=georchestra-127-0-1-1.traefik.me"
      - "caddy.tls=internal"
      - "caddy.handle=/cas/*"
      - "caddy.handle.0_reverse_proxy={{upstreams 8080}}"

  smtp:
    image: camptocamp/smtp-sink:latest
    volumes:
      - smtp_maildir:/home/smtp/Maildir/
    restart: always

  courier-imap:
    image: camptocamp/courier-imap:latest
    volumes:
      - smtp_maildir:/home/smtp/Maildir/
    restart: always

  webmail:
    image: camptocamp/sqwebmail:latest
    environment:
      - IMAP_HOSTNAME=courier-imap
      - SMTP_HOSTNAME=smtp-sink
    networks:
      - caddy
      - default
    volumes:
      - smtp_maildir:/home/smtp/Maildir/
    labels:
      - "caddy=georchestra-127-0-1-1.traefik.me"
      - "caddy.tls=internal"
      - "caddy.handle=/webmail/*"
      - "caddy.handle.0_reverse_proxy={{upstreams 80}}"
    restart: always

  ssh:
    image: georchestra/ssh_data:latest
    ports:
      - "2222:22"
    volumes:
      - geoserver_geodata:/mnt/geoserver_geodata
    restart: always

networks:
  caddy: